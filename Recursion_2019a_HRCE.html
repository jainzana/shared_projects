
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analysis of Recurion’s 2019a HRCE Dataset &#8212; My Jupyter Book</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-2 bd-sidebar site-navigation show single-page" id="site-navigation">
    
</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/Recursion_2019a_HRCE.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/Recursion_2019a_HRCE.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Analysis of Recurion’s 2019a HRCE Dataset
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-libraries-and-data">
   Import Libraries and Data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-overview">
   Data Overview
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview-of-original-metadata">
     Overview of original metadata
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview-of-original-feature-data">
     Overview of original feature data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#value-counts-for-each-cell-type-experiment-and-disease-condition">
     Value counts for each cell type, experiment, and disease condition
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initial-data-handling">
   Initial Data Handling
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exploratory-data-analysis">
   Exploratory Data Analysis
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#check-if-there-is-correlation-between-features">
     Check if there is correlation between features
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-distribution-of-controls-on-the-plates">
     Visualize the distribution of controls on the plates
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-the-control-distributions-for-a-couple-of-features">
     Examine the control distributions for a couple of features
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-feature-space-of-controls-in-2d-using-t-sne">
     Visualize feature space of controls in 2D using t-SNE
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-autocorrelations-by-well-row-and-column">
     Examine autocorrelations by well row and column
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-distribution-of-feature-values-within-each-group">
     Plot the distribution of feature values within each group
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#normalization">
   Normalization
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plate-normalization">
     Plate Normalization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-features-on-a-plate-format">
     Visualize the features on a plate format
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-features-across-rows-and-columns-for-all-active-wells">
     Visualize the features across rows and columns for all Active wells
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#remove-systematic-row-column-bias">
     Remove systematic row/column bias
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recheck-for-spatial-bias">
     Recheck for spatial bias
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#quantile-normalization">
     Quantile normalization
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#standardize-the-data-before-pca">
   Standardize the Data before PCA
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pca">
   PCA
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#remove-outliers">
   Remove Outliers
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-classifier-and-create-disease-axis">
   Fit Classifier and Create Disease Axis
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-the-disease-model">
   Evaluate the Disease Model
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overlay-of-disease-axes-for-both-experiments">
     Overlay of disease axes for both experiments
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pooled-disease-model">
     Pooled Disease Model
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#distributions-of-on-disease-scores-for-each-experiment">
     Distributions of On-disease scores for each experiment
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparison-of-consistency-across-experiments">
   Comparison of consistency across experiments
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#experiment-1-vs-experiment-2">
     Experiment 1 vs. Experiment 2
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mean-difference-plots-between-the-2-experiments">
       Mean-Difference plots between the 2 experiments
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluation-of-drug-candidates">
   Evaluation of Drug Candidates
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mean-score-of-each-treatment">
     Mean score of each treatment
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#key-treatments-that-were-in-both-experiments">
     Key treatments that were in both experiments
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-dose-response-curves-for-remdesivir">
     Plot the dose-response curves for Remdesivir
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hit-scores">
     Hit Scores
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Analysis of Recurion’s 2019a HRCE Dataset</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Analysis of Recurion’s 2019a HRCE Dataset
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-libraries-and-data">
   Import Libraries and Data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-overview">
   Data Overview
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview-of-original-metadata">
     Overview of original metadata
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview-of-original-feature-data">
     Overview of original feature data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#value-counts-for-each-cell-type-experiment-and-disease-condition">
     Value counts for each cell type, experiment, and disease condition
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initial-data-handling">
   Initial Data Handling
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exploratory-data-analysis">
   Exploratory Data Analysis
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#check-if-there-is-correlation-between-features">
     Check if there is correlation between features
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-distribution-of-controls-on-the-plates">
     Visualize the distribution of controls on the plates
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-the-control-distributions-for-a-couple-of-features">
     Examine the control distributions for a couple of features
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-feature-space-of-controls-in-2d-using-t-sne">
     Visualize feature space of controls in 2D using t-SNE
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-autocorrelations-by-well-row-and-column">
     Examine autocorrelations by well row and column
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-distribution-of-feature-values-within-each-group">
     Plot the distribution of feature values within each group
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#normalization">
   Normalization
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plate-normalization">
     Plate Normalization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-features-on-a-plate-format">
     Visualize the features on a plate format
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-features-across-rows-and-columns-for-all-active-wells">
     Visualize the features across rows and columns for all Active wells
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#remove-systematic-row-column-bias">
     Remove systematic row/column bias
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recheck-for-spatial-bias">
     Recheck for spatial bias
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#quantile-normalization">
     Quantile normalization
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#standardize-the-data-before-pca">
   Standardize the Data before PCA
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pca">
   PCA
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#remove-outliers">
   Remove Outliers
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-classifier-and-create-disease-axis">
   Fit Classifier and Create Disease Axis
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-the-disease-model">
   Evaluate the Disease Model
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overlay-of-disease-axes-for-both-experiments">
     Overlay of disease axes for both experiments
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pooled-disease-model">
     Pooled Disease Model
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#distributions-of-on-disease-scores-for-each-experiment">
     Distributions of On-disease scores for each experiment
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparison-of-consistency-across-experiments">
   Comparison of consistency across experiments
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#experiment-1-vs-experiment-2">
     Experiment 1 vs. Experiment 2
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mean-difference-plots-between-the-2-experiments">
       Mean-Difference plots between the 2 experiments
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluation-of-drug-candidates">
   Evaluation of Drug Candidates
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mean-score-of-each-treatment">
     Mean score of each treatment
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#key-treatments-that-were-in-both-experiments">
     Key treatments that were in both experiments
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-dose-response-curves-for-remdesivir">
     Plot the dose-response curves for Remdesivir
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hit-scores">
     Hit Scores
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="analysis-of-recurion-s-2019a-hrce-dataset">
<h1>Analysis of Recurion’s 2019a HRCE Dataset<a class="headerlink" href="#analysis-of-recurion-s-2019a-hrce-dataset" title="Permalink to this headline">¶</a></h1>
<p><strong>Author: Jason Inzana</strong></p>
<p>This analysis uses a subset of the <a class="reference external" href="https://www.rxrx.ai/rxrx19a">2019a dataset</a> shared by Recursion. This analysis only includes the HRCE cell data. I was inspired to tinker with this data after reading Recursion’s <a class="reference external" href="https://www.biorxiv.org/lookup/doi/10.1101/2020.04.21.054387">publication on this dataset</a>.</p>
<p>My goal was not to perfectly replicate the published work, but to use it as an initial guide and implement my own approach based on my current knowlege and understanding of HTS assays. This was my first time working with this type of data - it’s a fun learning experience and a work in progress.</p>
<p>This analysis indicates that GS-441524 and Remdesivir are the top 2 drug candidates.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="import-libraries-and-data">
<h1>Import Libraries and Data<a class="headerlink" href="#import-libraries-and-data" title="Permalink to this headline">¶</a></h1>
<div class="cell tag_hide-input tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics</span> <span class="kn">import</span> <span class="n">tsaplots</span>

<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.discriminant_analysis</span> <span class="kn">import</span> <span class="n">LinearDiscriminantAnalysis</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">QuantileTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>


<span class="c1"># Load in the dataset, which is subset of the full dataset that only contains HRCE data and treatments that were shared between the 2 experiments</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Volumes/GoogleDrive/My Drive/Colab Notebooks/Recursion COVID/metadata.csv&#39;</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Volumes/GoogleDrive/My Drive/Colab Notebooks/Recursion COVID/embeddings.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="data-overview">
<h1>Data Overview<a class="headerlink" href="#data-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview-of-original-metadata">
<h2>Overview of original metadata<a class="headerlink" href="#overview-of-original-metadata" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>site_id</th>
      <th>well_id</th>
      <th>cell_type</th>
      <th>experiment</th>
      <th>plate</th>
      <th>well</th>
      <th>site</th>
      <th>disease_condition</th>
      <th>treatment</th>
      <th>treatment_conc</th>
      <th>SMILES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>HRCE-1_1_AA02_1</td>
      <td>HRCE-1_1_AA02</td>
      <td>HRCE</td>
      <td>HRCE-1</td>
      <td>1</td>
      <td>AA02</td>
      <td>1</td>
      <td>Active SARS-CoV-2</td>
      <td>Flubendazole</td>
      <td>0.1</td>
      <td>COC(=O)NC1=NC2=C(N1)C=C(C=C2)C(=O)C1=CC=C(F)C=...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>HRCE-1_1_AA02_2</td>
      <td>HRCE-1_1_AA02</td>
      <td>HRCE</td>
      <td>HRCE-1</td>
      <td>1</td>
      <td>AA02</td>
      <td>2</td>
      <td>Active SARS-CoV-2</td>
      <td>Flubendazole</td>
      <td>0.1</td>
      <td>COC(=O)NC1=NC2=C(N1)C=C(C=C2)C(=O)C1=CC=C(F)C=...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>HRCE-1_1_AA02_3</td>
      <td>HRCE-1_1_AA02</td>
      <td>HRCE</td>
      <td>HRCE-1</td>
      <td>1</td>
      <td>AA02</td>
      <td>3</td>
      <td>Active SARS-CoV-2</td>
      <td>Flubendazole</td>
      <td>0.1</td>
      <td>COC(=O)NC1=NC2=C(N1)C=C(C=C2)C(=O)C1=CC=C(F)C=...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>HRCE-1_1_AA02_4</td>
      <td>HRCE-1_1_AA02</td>
      <td>HRCE</td>
      <td>HRCE-1</td>
      <td>1</td>
      <td>AA02</td>
      <td>4</td>
      <td>Active SARS-CoV-2</td>
      <td>Flubendazole</td>
      <td>0.1</td>
      <td>COC(=O)NC1=NC2=C(N1)C=C(C=C2)C(=O)C1=CC=C(F)C=...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>HRCE-1_1_AA03_1</td>
      <td>HRCE-1_1_AA03</td>
      <td>HRCE</td>
      <td>HRCE-1</td>
      <td>1</td>
      <td>AA03</td>
      <td>1</td>
      <td>Active SARS-CoV-2</td>
      <td>acetylcysteine</td>
      <td>1.0</td>
      <td>CC(=O)N[C@H](CS)C(O)=O |a:4,r|</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="overview-of-original-feature-data">
<h2>Overview of original feature data<a class="headerlink" href="#overview-of-original-feature-data" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>site_id</th>
      <th>feature_0</th>
      <th>feature_1</th>
      <th>feature_2</th>
      <th>feature_3</th>
      <th>feature_4</th>
      <th>feature_5</th>
      <th>feature_6</th>
      <th>feature_7</th>
      <th>feature_8</th>
      <th>...</th>
      <th>feature_1014</th>
      <th>feature_1015</th>
      <th>feature_1016</th>
      <th>feature_1017</th>
      <th>feature_1018</th>
      <th>feature_1019</th>
      <th>feature_1020</th>
      <th>feature_1021</th>
      <th>feature_1022</th>
      <th>feature_1023</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>HRCE-1_10_AA02_1</td>
      <td>2.355969</td>
      <td>-0.058361</td>
      <td>-0.169764</td>
      <td>-0.316499</td>
      <td>-0.891334</td>
      <td>0.581174</td>
      <td>-0.284587</td>
      <td>-0.279198</td>
      <td>-0.146575</td>
      <td>...</td>
      <td>0.391186</td>
      <td>0.786199</td>
      <td>-1.739626</td>
      <td>-1.317543</td>
      <td>-1.208275</td>
      <td>-0.507439</td>
      <td>-0.317298</td>
      <td>0.285018</td>
      <td>-0.091285</td>
      <td>-1.553895</td>
    </tr>
    <tr>
      <th>1</th>
      <td>HRCE-1_10_AA02_2</td>
      <td>2.325652</td>
      <td>-0.202519</td>
      <td>-0.296017</td>
      <td>-0.481136</td>
      <td>-0.641461</td>
      <td>0.702847</td>
      <td>0.334191</td>
      <td>-0.077498</td>
      <td>-0.314538</td>
      <td>...</td>
      <td>0.638674</td>
      <td>1.051621</td>
      <td>-1.355659</td>
      <td>-1.285210</td>
      <td>-1.341911</td>
      <td>-0.271349</td>
      <td>-0.157707</td>
      <td>0.081128</td>
      <td>-0.447174</td>
      <td>-1.614872</td>
    </tr>
    <tr>
      <th>2</th>
      <td>HRCE-1_10_AA02_3</td>
      <td>2.207082</td>
      <td>-0.379794</td>
      <td>-0.365562</td>
      <td>-0.196667</td>
      <td>-0.799039</td>
      <td>0.735813</td>
      <td>0.081227</td>
      <td>-0.393452</td>
      <td>0.066324</td>
      <td>...</td>
      <td>0.552127</td>
      <td>0.775428</td>
      <td>-1.616731</td>
      <td>-0.868382</td>
      <td>-1.334486</td>
      <td>-0.774456</td>
      <td>-0.363250</td>
      <td>0.161023</td>
      <td>-0.066745</td>
      <td>-1.325545</td>
    </tr>
    <tr>
      <th>3</th>
      <td>HRCE-1_10_AA02_4</td>
      <td>2.452741</td>
      <td>0.050658</td>
      <td>-0.444642</td>
      <td>-0.309758</td>
      <td>-0.724900</td>
      <td>0.658327</td>
      <td>-0.128331</td>
      <td>-0.164759</td>
      <td>0.279105</td>
      <td>...</td>
      <td>0.689145</td>
      <td>1.167066</td>
      <td>-1.275786</td>
      <td>-2.088455</td>
      <td>-1.231964</td>
      <td>-0.364454</td>
      <td>-0.135066</td>
      <td>0.493010</td>
      <td>-0.544680</td>
      <td>-1.290150</td>
    </tr>
    <tr>
      <th>4</th>
      <td>HRCE-1_10_AA03_1</td>
      <td>2.106868</td>
      <td>0.032095</td>
      <td>-0.175542</td>
      <td>-0.808618</td>
      <td>-0.806217</td>
      <td>0.721340</td>
      <td>-0.213196</td>
      <td>-0.187649</td>
      <td>-0.070294</td>
      <td>...</td>
      <td>0.385696</td>
      <td>0.503924</td>
      <td>-1.192554</td>
      <td>-1.123965</td>
      <td>-1.323457</td>
      <td>-0.359761</td>
      <td>-0.100340</td>
      <td>0.185773</td>
      <td>-0.394267</td>
      <td>-1.712760</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 1025 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="value-counts-for-each-cell-type-experiment-and-disease-condition">
<h2>Value counts for each cell type, experiment, and disease condition<a class="headerlink" href="#value-counts-for-each-cell-type-experiment-and-disease-condition" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;disease_condition&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cell_type  experiment  disease_condition        
HRCE       HRCE-2      Active SARS-CoV-2            132776
           HRCE-1      Active SARS-CoV-2            127920
VERO       VERO-1      Active SARS-CoV-2              9840
           VERO-2      Active SARS-CoV-2              9840
HRCE       HRCE-2      Mock                           4320
                       UV Inactivated SARS-CoV-2      4320
           HRCE-1      Mock                           4160
                       UV Inactivated SARS-CoV-2      4160
VERO       VERO-1      Mock                            320
                       UV Inactivated SARS-CoV-2       320
           VERO-2      Mock                            320
                       UV Inactivated SARS-CoV-2       320
dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="initial-data-handling">
<h1>Initial Data Handling<a class="headerlink" href="#initial-data-handling" title="Permalink to this headline">¶</a></h1>
<p>In this section, I do some simple data preparation:</p>
<ul class="simple">
<li><p>Drop VERO data to focus on HRCE cell data only</p></li>
<li><p>Reduce the measurements to 1 measurement per well by averaging over the 4 sites in each well</p></li>
<li><p>Rename the disease condition to simpler names (i.e., Active vs. Inactive)</p></li>
<li><p>Extract row and column numbers from the well ID for 2D localization on a given plate</p></li>
<li><p>Create a new metadata column “groups” to define the positive and negative control groups vs treated</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Just HRCE</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;HRCE&#39;</span><span class="p">,:]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;site_id&#39;</span><span class="p">)</span> 
<span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;site_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="c1"># Tidy the metadata; average features over the sites in each well to get 1 value per well</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">well_id</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;well_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;well_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Simplify the metadata and make it a bit easier to work with</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;UV Inactivated SARS-CoV-2&#39;</span><span class="p">:</span> <span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Active SARS-CoV-2&#39;</span><span class="p">:</span> <span class="s1">&#39;Active&#39;</span><span class="p">})</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">treatment</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">treatment_conc</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;SMILES&#39;</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_type&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Decompose the well number into column and row labels</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;well&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(?P&lt;well_row&gt;\D+)(?P&lt;well_col&gt;\d+)&#39;</span><span class="p">))</span>

<span class="c1"># Relabel the rows with numbers instead of letters</span>
<span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;AA&#39;</span><span class="p">,</span> <span class="s1">&#39;AB&#39;</span><span class="p">,</span> <span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;AD&#39;</span><span class="p">,</span> <span class="s1">&#39;AE&#39;</span><span class="p">,</span> <span class="s1">&#39;AF&#39;</span><span class="p">]</span>
<span class="n">row_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">well_row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">row_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;well&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Define Groups</span>
<span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="p">[</span>
    <span class="p">((</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Active&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">treatment</span><span class="o">==</span><span class="s1">&#39;None&#39;</span><span class="p">)),</span>
    <span class="p">((</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Inactive&#39;</span><span class="p">)),</span>
    <span class="p">((</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Active&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">treatment</span><span class="o">!=</span><span class="s1">&#39;None&#39;</span><span class="p">)),</span>
    <span class="p">((</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Mock&#39;</span><span class="p">)),</span>
    <span class="p">((</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;None&#39;</span><span class="p">)),</span>
    <span class="p">],</span> 
    <span class="p">[</span>
    <span class="s1">&#39;pos_ctrl&#39;</span><span class="p">,</span>
    <span class="s1">&#39;neg_ctrl&#39;</span><span class="p">,</span>
    <span class="s1">&#39;treated&#39;</span><span class="p">,</span>
    <span class="s1">&#39;neg_ctrl_2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;none_ctrl&#39;</span>
    <span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Define sample groups of replicates within each experiment</span>
<span class="n">samp_group</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment_conc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;samp_group&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">samp_group</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment_conc&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">samp_group</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">samp_group</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Save groups based on index for easier slicing later</span>
<span class="n">pos_ctrl</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[(</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Active&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">treatment</span><span class="o">==</span><span class="s1">&#39;None&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
<span class="n">neg_ctrl</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[(</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Inactive&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">treatment</span><span class="o">==</span><span class="s1">&#39;None&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
<span class="n">all_active</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Active&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">main_ctrls</span> <span class="o">=</span> <span class="n">pos_ctrl</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">neg_ctrl</span><span class="p">)</span>
<span class="n">neg_ctrl_2</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[(</span><span class="n">metadata</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">==</span><span class="s1">&#39;Mock&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">treatment</span><span class="o">==</span><span class="s1">&#39;None&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="exploratory-data-analysis">
<h1>Exploratory Data Analysis<a class="headerlink" href="#exploratory-data-analysis" title="Permalink to this headline">¶</a></h1>
<div class="section" id="check-if-there-is-correlation-between-features">
<h2>Check if there is correlation between features<a class="headerlink" href="#check-if-there-is-correlation-between-features" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Randomly selected 100 features to look at</p></li>
<li><p>Positive and negative correlations are evident among features, suggesting the feature space can be reduced effectively with PCA</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">));</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;vlag&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlations Among 100 Random Features&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_15_0.png" src="_images/Recursion_2019a_HRCE_15_0.png" />
</div>
</div>
</div>
<div class="section" id="visualize-the-distribution-of-controls-on-the-plates">
<h2>Visualize the distribution of controls on the plates<a class="headerlink" href="#visualize-the-distribution-of-controls-on-the-plates" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>It looks like the negative controls (cyan, magenta, blue) are not randomized within each plate and the positive controls (red) are never in the same column as negative controls.</p></li>
<li><p>Positive controls (red) are randomized among treated wells (green)</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">curr_ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
  <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">platedata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span><span class="mi">48</span><span class="p">]),</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">33</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">49</span><span class="p">))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">curr_ax</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
  
  <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">plate</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">currdata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">plate</span> <span class="o">==</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;pos_ctrl&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;treated&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;neg_ctrl&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;neg_ctrl_2&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;none_ctrl&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">})</span>
    <span class="n">platedata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">currdata</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">currdata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">currdata</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">platedata</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Plate </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">25</span><span class="p">});</span>    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_17_0.png" src="_images/Recursion_2019a_HRCE_17_0.png" />
</div>
</div>
</div>
<div class="section" id="examine-the-control-distributions-for-a-couple-of-features">
<h2>Examine the control distributions for a couple of features<a class="headerlink" href="#examine-the-control-distributions-for-a-couple-of-features" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Generally, distributions within each plate are approximately bell-shaped (normal) with a few exceptions, suggesting there may be differences or systematic bias between and/or within plates</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_ctrls</span><span class="p">]</span>
<span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Feature 0&#39;</span><span class="p">,</span> <span class="s1">&#39;Feature 4&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;feature_0&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_4&#39;</span><span class="p">]):</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">25</span><span class="p">});</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Plate&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">25</span><span class="p">});</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">});</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">});</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_19_0.png" src="_images/Recursion_2019a_HRCE_19_0.png" />
</div>
</div>
</div>
<div class="section" id="visualize-feature-space-of-controls-in-2d-using-t-sne">
<h2>Visualize feature space of controls in 2D using t-SNE<a class="headerlink" href="#visualize-feature-space-of-controls-in-2d-using-t-sne" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>It looks like there is some clustering related to the plate and there are certainly batch effects between experiments</p></li>
<li><p>Some of the “Active” positive control wells seem to cluster with the Mock negative control wells - perhaps the viral infection was not successful in those wells? Anomalies to be removed?</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s1">&#39;pca&#39;</span><span class="p">)</span>
<span class="n">tsne_f</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_ctrls</span><span class="p">])</span>
<span class="n">tsne_f</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tsne_f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">main_ctrls</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TSNE_1&#39;</span><span class="p">,</span> <span class="s1">&#39;TSNE_2&#39;</span><span class="p">])</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;TSNE_1&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;TSNE_2&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">tsne_f</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;TSNE_1&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;TSNE_2&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;tab20&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">tsne_f</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">();</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/sklearn/manifold/_t_sne.py:790: FutureWarning: The default learning rate in TSNE will change from 200.0 to &#39;auto&#39; in 1.2.
  warnings.warn(
/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/sklearn/manifold/_t_sne.py:982: FutureWarning: The PCA initialization in TSNE will change to have the standard deviation of PC1 equal to 1e-4 in 1.2. This will ensure better convergence.
  warnings.warn(
</pre></div>
</div>
<img alt="_images/Recursion_2019a_HRCE_21_1.png" src="_images/Recursion_2019a_HRCE_21_1.png" />
</div>
</div>
</div>
<div class="section" id="examine-autocorrelations-by-well-row-and-column">
<h2>Examine autocorrelations by well row and column<a class="headerlink" href="#examine-autocorrelations-by-well-row-and-column" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>There are some significant autocorrelations for the positive controls and All Active wells (positive controls plus treated wells) that suggest there may be spatial bias (rows / columns) on the plate</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat</span> <span class="o">=</span> <span class="s1">&#39;feature_0&#39;</span>
<span class="n">exp</span> <span class="o">=</span> <span class="s1">&#39;HRCE-1&#39;</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos_ctrl</span><span class="p">,</span> <span class="n">all_active</span><span class="p">,</span> <span class="n">neg_ctrl</span><span class="p">]</span>
<span class="n">group_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pos Ctrls&#39;</span><span class="p">,</span> <span class="s1">&#39;All Active&#39;</span><span class="p">,</span> <span class="s1">&#39;Neg Ctrls&#39;</span><span class="p">]</span>
<span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">]</span>
<span class="n">direction_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Columns&#39;</span><span class="p">,</span> <span class="s1">&#39;Rows&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">group_lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">group_labels</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">dir_lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">directions</span><span class="p">,</span> <span class="n">direction_labels</span><span class="p">)):</span>
                     
        <span class="n">data</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">)]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">group</span><span class="p">)]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">direction</span><span class="p">])</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        
        <span class="n">tsaplots</span><span class="o">.</span><span class="n">plot_acf</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">feat</span><span class="p">],</span> 
                          <span class="n">zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">lags</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lag&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ACF over &#39;</span> <span class="o">+</span> <span class="n">dir_lab</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        
        <span class="n">tsaplots</span><span class="o">.</span><span class="n">plot_pacf</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">feat</span><span class="p">],</span> 
                          <span class="n">zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">lags</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Partial ACF over &#39;</span> <span class="o">+</span> <span class="n">dir_lab</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lag&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        
    <span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">group_lab</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/statsmodels/graphics/tsaplots.py:348: FutureWarning: The default method &#39;yw&#39; can produce PACF values outside of the [-1,1] interval. After 0.13, the default will change tounadjusted Yule-Walker (&#39;ywm&#39;). You can use this method now by setting method=&#39;ywm&#39;.
  warnings.warn(
/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/statsmodels/graphics/tsaplots.py:348: FutureWarning: The default method &#39;yw&#39; can produce PACF values outside of the [-1,1] interval. After 0.13, the default will change tounadjusted Yule-Walker (&#39;ywm&#39;). You can use this method now by setting method=&#39;ywm&#39;.
  warnings.warn(
/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/statsmodels/graphics/tsaplots.py:348: FutureWarning: The default method &#39;yw&#39; can produce PACF values outside of the [-1,1] interval. After 0.13, the default will change tounadjusted Yule-Walker (&#39;ywm&#39;). You can use this method now by setting method=&#39;ywm&#39;.
  warnings.warn(
/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/statsmodels/graphics/tsaplots.py:348: FutureWarning: The default method &#39;yw&#39; can produce PACF values outside of the [-1,1] interval. After 0.13, the default will change tounadjusted Yule-Walker (&#39;ywm&#39;). You can use this method now by setting method=&#39;ywm&#39;.
  warnings.warn(
/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/statsmodels/graphics/tsaplots.py:348: FutureWarning: The default method &#39;yw&#39; can produce PACF values outside of the [-1,1] interval. After 0.13, the default will change tounadjusted Yule-Walker (&#39;ywm&#39;). You can use this method now by setting method=&#39;ywm&#39;.
  warnings.warn(
/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/statsmodels/graphics/tsaplots.py:348: FutureWarning: The default method &#39;yw&#39; can produce PACF values outside of the [-1,1] interval. After 0.13, the default will change tounadjusted Yule-Walker (&#39;ywm&#39;). You can use this method now by setting method=&#39;ywm&#39;.
  warnings.warn(
</pre></div>
</div>
<img alt="_images/Recursion_2019a_HRCE_23_1.png" src="_images/Recursion_2019a_HRCE_23_1.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-distribution-of-feature-values-within-each-group">
<h2>Plot the distribution of feature values within each group<a class="headerlink" href="#plot-the-distribution-of-feature-values-within-each-group" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>One specific treatment (Chloroquine) was selected to represent a treated sample that had large off-disease effects in Recursion’s publication</p></li>
<li><p>The 1024 features seem to be normally distributed with mean~0, within groups or randomly selected samples. Standardizing these feature distributions using quantile normalization within each replicated treatment or control group could be appropriate to help reduce variance</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;none_ctrl&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">treatment</span><span class="o">==</span><span class="s1">&#39;Chloroquine&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">treatment_conc</span><span class="o">==</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># instead of a random treated, use one with known difference from ctrls</span>
<span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;treated&#39;</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Median Feature Distributions&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Feature Values&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Chloroquine&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">,</span> <span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Mock&#39;</span><span class="p">]);</span>

<span class="n">data2</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">data2</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;none_ctrl&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;treated&#39;</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Feature Distributions of a random well from each group&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Feature Values&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Chloroquine&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">,</span> <span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Mock&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_25_0.png" src="_images/Recursion_2019a_HRCE_25_0.png" />
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="normalization">
<h1>Normalization<a class="headerlink" href="#normalization" title="Permalink to this headline">¶</a></h1>
<div class="section" id="plate-normalization">
<h2>Plate Normalization<a class="headerlink" href="#plate-normalization" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Robust normalization of each plate based on the negative control, followed by median shift of all Active virus wells based on positive control</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Normalize each plate based on the negative control data</span>

<span class="n">features_norm</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span> <span class="c1"># For each experiment</span>
     
  <span class="k">for</span> <span class="n">plate</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">plate</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span> <span class="c1"># For each microplate in the experiment</span>

    <span class="n">curr</span> <span class="o">=</span> <span class="n">features_norm</span><span class="p">[(</span><span class="n">metadata</span><span class="o">.</span><span class="n">plate</span> <span class="o">==</span> <span class="n">plate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span> <span class="o">==</span> <span class="n">exp</span><span class="p">)]</span> <span class="c1"># current plate in the experiment</span>

    <span class="c1"># Robust normalization based on negative controls within the plate</span>
    <span class="n">idx_mask</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">neg_ctrl</span><span class="p">)</span>
    <span class="n">med_neg</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_mask</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span> <span class="c1"># Median of negative control on the plate    </span>
    <span class="n">mad_neg</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_mask</span><span class="p">]</span><span class="o">.</span><span class="n">mad</span><span class="p">()</span> <span class="c1"># MAD of neg ctrl on plate    </span>
    <span class="n">features_norm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">med_neg</span><span class="p">)</span> <span class="o">/</span> <span class="n">mad_neg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Robust normalization based on the median and MAD of the negative conrol group within each plate, on each feature</span>
    
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualize-the-features-on-a-plate-format">
<h2>Visualize the features on a plate format<a class="headerlink" href="#visualize-the-features-on-a-plate-format" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The “All Active” (right) plot certainly looks like there are some edge effects at least</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the feature median on the plate</span>
<span class="n">exp</span> <span class="o">=</span> <span class="s1">&#39;HRCE-1&#39;</span>
<span class="n">feat</span> <span class="o">=</span> <span class="s1">&#39;feature_0&#39;</span>

<span class="n">data_neg</span> <span class="o">=</span> <span class="n">features_norm</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neg_ctrl</span><span class="p">]</span>
<span class="n">data_neg</span> <span class="o">=</span> <span class="n">data_neg</span><span class="p">[</span><span class="n">data_neg</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="s1">&#39;well_col&#39;</span><span class="p">])[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">data_pos</span> <span class="o">=</span> <span class="n">features_norm</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pos_ctrl</span><span class="p">]</span>
<span class="n">data_pos</span> <span class="o">=</span> <span class="n">data_pos</span><span class="p">[</span><span class="n">data_pos</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="s1">&#39;well_col&#39;</span><span class="p">])[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">data_allactive</span> <span class="o">=</span> <span class="n">features_norm</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_active</span><span class="p">]</span>
<span class="n">data_allactive</span> <span class="o">=</span> <span class="n">data_allactive</span><span class="p">[</span><span class="n">data_allactive</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="s1">&#39;well_col&#39;</span><span class="p">])[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">data_neg</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Negative Controls; feature_0&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Positive Controls; feature_0&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">data_allactive</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;All Active Wells; feature_0&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_30_0.png" src="_images/Recursion_2019a_HRCE_30_0.png" />
</div>
</div>
</div>
<div class="section" id="visualize-the-features-across-rows-and-columns-for-all-active-wells">
<h2>Visualize the features across rows and columns for all Active wells<a class="headerlink" href="#visualize-the-features-across-rows-and-columns-for-all-active-wells" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Across columns (left), there are clearly edge effects</p></li>
<li><p>Edge effects also seem to exist across rows, but there is also greater oscillating variation across the plate</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">features_norm</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_active</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="s1">&#39;well_col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">_</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;feature_0&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_1&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_2&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_3&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_4&#39;</span><span class="p">,</span> <span class="s1">&#39;well_col&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;well_col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Well Column&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Feature values&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Features plotted over well columns&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;feature_0&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_1&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_2&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_3&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_4&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;well_row&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Well Row&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Feature values&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Features plotted over well rows&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_32_0.png" src="_images/Recursion_2019a_HRCE_32_0.png" />
</div>
</div>
</div>
<div class="section" id="remove-systematic-row-column-bias">
<h2>Remove systematic row/column bias<a class="headerlink" href="#remove-systematic-row-column-bias" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Apply the median polish using the overall median plate as a spatial bias template, which will help avoid random effects that exist on any one plate</p></li>
<li><p>Median polish the negative controls separately since there is not column overlap with Active wells</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do a median polish of column and row effects based on the medians over all plates within an experiment</span>

<span class="n">features_mp</span> <span class="o">=</span> <span class="n">features_norm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">max_iter</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
  <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">[</span><span class="n">neg_ctrl</span><span class="p">,</span> <span class="n">neg_ctrl_2</span><span class="p">,</span> <span class="n">all_active</span><span class="p">]:</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="n">features_mp</span><span class="p">[(</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span> <span class="o">==</span> <span class="n">exp</span><span class="p">)]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">]])</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">group</span><span class="p">)]</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">],</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">overall_med</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">median_plate</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span><span class="s1">&#39;well_row&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>  
      <span class="n">col_meds</span> <span class="o">=</span> <span class="n">median_plate</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;well_col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
      <span class="n">col_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_meds</span> <span class="o">-</span> <span class="n">overall_med</span><span class="p">)[</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
      
      <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">-</span> <span class="n">col_diff</span>

      <span class="n">median_plate</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span><span class="s1">&#39;well_row&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
      <span class="n">row_meds</span> <span class="o">=</span> <span class="n">median_plate</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;well_row&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
      <span class="n">row_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">row_meds</span> <span class="o">-</span> <span class="n">overall_med</span><span class="p">)[</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

      <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">-</span> <span class="n">row_diff</span>
    
    <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">droplevel</span><span class="p">([</span><span class="s1">&#39;well_col&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">])</span>
    <span class="n">features_mp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="recheck-for-spatial-bias">
<h2>Recheck for spatial bias<a class="headerlink" href="#recheck-for-spatial-bias" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Since we are looking at the median over all plates, it makes sense that there is minimal/zero variation</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">features_mp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_active</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;well_row&#39;</span><span class="p">,</span> <span class="s1">&#39;well_col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">_</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;feature_0&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_1&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_2&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_3&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_4&#39;</span><span class="p">,</span> <span class="s1">&#39;well_col&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;well_col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Well Column&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Feature values&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Features plotted over well columns&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;feature_0&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_1&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_2&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_3&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_4&#39;</span><span class="p">,</span> <span class="s1">&#39;well_row&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;well_row&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Well Row&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Feature values&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Features plotted over well rows&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_36_0.png" src="_images/Recursion_2019a_HRCE_36_0.png" />
</div>
</div>
</div>
<div class="section" id="quantile-normalization">
<h2>Quantile normalization<a class="headerlink" href="#quantile-normalization" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Within each treatment/control group, quantile transform the feature distribution to match the median distribution of that group</p></li>
<li><p>This approach is analogous to the Discrete method described by <a class="reference external" href="https://www.nature.com/articles/s41598-020-72664-6">Zhao et al. 2020</a> for gene expression. Only in this case, the different features are being treated like the different genes, a “class” is a replicated treatment group or control group, and the batch is the experiment.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_qn</span> <span class="o">=</span> <span class="n">features_mp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">samp_group</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
  <span class="n">curr</span> <span class="o">=</span> <span class="n">features_qn</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">samp_group</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
  <span class="n">curr_values</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">curr_ranks</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
  <span class="n">curr_values</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">mean_vals</span> <span class="o">=</span> <span class="n">curr_values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1025</span><span class="p">))</span>
  <span class="n">ranks_melt</span> <span class="o">=</span> <span class="n">curr_ranks</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">value_vars</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">vals_melt</span> <span class="o">=</span> <span class="n">ranks_melt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">vals_melt</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">mean_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ranks_melt</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
  <span class="n">curr</span> <span class="o">=</span> <span class="n">vals_melt</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
  <span class="n">features_qn</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="standardize-the-data-before-pca">
<h1>Standardize the Data before PCA<a class="headerlink" href="#standardize-the-data-before-pca" title="Permalink to this headline">¶</a></h1>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_std</span> <span class="o">=</span> <span class="n">features_qn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Standardize the data within each feature before PCA</span>
<span class="c1">#   For each experiment, treat the negative and positive control data as &quot;training&quot; data and the rest as &quot;test&quot; data </span>
<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>

  <span class="c1"># Get index masks</span>
  <span class="n">tx_idx</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">main_ctrls</span><span class="p">)</span> <span class="c1"># rest of the samples</span>
  <span class="n">exp_idx</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="c1"># all samples in this experiment</span>
  <span class="c1"># Instantiate scaler</span>
  <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
  <span class="c1"># Fit and transform based on the controls in this experiment</span>
  <span class="n">features_std</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">features_std</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)])</span>
  <span class="c1"># Transform the remaining treatment groups in this experiment</span>
  <span class="n">features_std</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tx_idx</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_std</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tx_idx</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="pca">
<h1>PCA<a class="headerlink" href="#pca" title="Permalink to this headline">¶</a></h1>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do PCA to reduce feature space and create orthogonal features</span>

<span class="c1"># Setup PCs dataframe with new column labels</span>
<span class="n">pca_feats</span> <span class="o">=</span> <span class="n">features_std</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">PC_n</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># number of PCs </span>
<span class="n">PC_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;PC&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">PC_n</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PC_n</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))]</span> <span class="c1"># Make list of PC# columns labels</span>
<span class="n">pca_feats</span> <span class="o">=</span> <span class="n">pca_feats</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">PC_n</span><span class="p">]</span>
<span class="n">pca_feats</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">PC_cols</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pca_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># initial index of PCs to keep - update in for loop</span>

<span class="c1"># Do PCA separately for each experiment</span>
<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>

  <span class="c1"># Get index masks</span>
  <span class="n">tx_idx</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">main_ctrls</span><span class="p">)</span>
  <span class="n">exp_idx</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

  <span class="c1"># Instantiate PCA model</span>
  <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">whiten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="n">PC_n</span><span class="p">,</span> <span class="n">svd_solver</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>

  <span class="c1"># Fit and transform based on the controls in this experiment</span>
  <span class="n">pca_feats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">pca_feats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)])</span>
  
  <span class="c1"># Transform the remaining groups in this experiment</span>
  <span class="n">pca_feats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tx_idx</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">pca_feats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tx_idx</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)])</span>

  <span class="c1"># Determine how many PCs to keep based on threshold of overall variance explained</span>
  <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.95</span>
  <span class="n">curr_pca_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
  <span class="c1"># Just use the max number of PCs needed to explain at least thresh% variance across each experiment</span>
  <span class="k">if</span> <span class="n">curr_pca_idx</span> <span class="o">&gt;</span> <span class="n">pca_idx</span><span class="p">:</span>
    <span class="n">pca_idx</span> <span class="o">=</span> <span class="n">curr_pca_idx</span> 

<span class="c1"># Filter the PCs to keep</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PCs kept:&#39;</span><span class="p">,</span> <span class="n">pca_idx</span><span class="p">)</span>
<span class="n">PC_2_keep</span> <span class="o">=</span> <span class="n">PC_cols</span><span class="p">[:</span><span class="n">pca_idx</span><span class="p">]</span>
<span class="n">pca_feats</span> <span class="o">=</span> <span class="n">pca_feats</span><span class="p">[</span><span class="n">PC_2_keep</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PCs kept: 119
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="remove-outliers">
<h1>Remove Outliers<a class="headerlink" href="#remove-outliers" title="Permalink to this headline">¶</a></h1>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove outliers within each control group based on Mahalanobis distance and cosine similarity</span>

<span class="n">pca_final</span> <span class="o">=</span> <span class="n">pca_feats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
  <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="p">[</span><span class="n">neg_ctrl</span><span class="p">,</span> <span class="n">pos_ctrl</span><span class="p">]:</span>

    <span class="n">idx_mask</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>  
    <span class="n">curr</span> <span class="o">=</span> <span class="n">pca_final</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_mask</span><span class="p">]</span> <span class="c1"># current ctrl and experiment</span>

    <span class="c1"># Calculate covariance matrices</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
    <span class="c1"># Calculate inverse cov mat</span>
    <span class="n">inv_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="c1"># Caluclate PC means</span>
    <span class="n">feat_means</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>    
    <span class="c1"># Instantiate mahal lambda funcs</span>
    <span class="n">mahal_lam</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">mahalanobis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">feat_means</span><span class="p">,</span> <span class="n">inv_cov</span><span class="p">)</span>
    <span class="c1"># Calculate mahalanobis distance</span>
    <span class="n">mahalD</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">mahal_lam</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Calculate cutoff to define outliers</span>
    <span class="n">Q1</span> <span class="o">=</span> <span class="n">mahalD</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">Q3</span> <span class="o">=</span> <span class="n">mahalD</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">IQR</span>     
    <span class="n">outliers_mahal</span> <span class="o">=</span> <span class="n">mahalD</span><span class="p">[</span><span class="n">mahalD</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>


    <span class="c1">## Cosine Similarity</span>
    <span class="c1"># Median control vector</span>
    <span class="n">curr_med</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="c1"># Cosine similarity of each sample to the median</span>
    <span class="n">cos_sim_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cosine</span><span class="p">(</span><span class="n">curr_med</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cos_sim_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate cutoff to define outliers</span>
    <span class="n">Q1</span> <span class="o">=</span> <span class="n">cos_sim</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">Q3</span> <span class="o">=</span> <span class="n">cos_sim</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
    <span class="n">cutoff_hi</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">IQR</span>
    <span class="n">cutoff_lo</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">IQR</span>      
    <span class="n">outliers_cos</span> <span class="o">=</span> <span class="n">cos_sim</span><span class="p">[(</span><span class="n">cos_sim</span> <span class="o">&gt;</span> <span class="n">cutoff_hi</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cos_sim</span> <span class="o">&lt;</span> <span class="n">cutoff_lo</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># Drop outliers</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">outliers_cos</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">outliers_mahal</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Outliers dropped for </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.2}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_mask</span><span class="p">]</span><span class="o">.</span><span class="n">disease_condition</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">pca_final</span> <span class="o">=</span> <span class="n">pca_final</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">outliers</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outliers dropped for HRCE-1, Inactive: 1.2%
Outliers dropped for HRCE-1, Active: 3.4%
Outliers dropped for HRCE-2, Inactive: 1.1%
Outliers dropped for HRCE-2, Active: 3.2%
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="fit-classifier-and-create-disease-axis">
<h1>Fit Classifier and Create Disease Axis<a class="headerlink" href="#fit-classifier-and-create-disease-axis" title="Permalink to this headline">¶</a></h1>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit Classifier</span>
<span class="c1">#model = LogisticRegression(C=0.001, max_iter=10000)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearDiscriminantAnalysis</span><span class="p">()</span> <span class="c1"># Deafult LDA yields similar results to LR with regularization</span>

<span class="c1"># Initialize dataframes to contain results of interest</span>
<span class="n">disease_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">pca_final</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="s1">&#39;off_disease_score&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
<span class="n">Zfactor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Create separately for each experiment - correct for batch effect by normalizing scores between 0 and 1</span>
<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>

  <span class="c1"># Just use the positive and negative controls to train the classifier and then use treatment data as &quot;test&quot; data</span>
  <span class="n">idx_mask</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pca_final</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="c1"># current experiment and data without outliers</span>
  <span class="n">curr_data</span> <span class="o">=</span> <span class="n">pca_final</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_mask</span><span class="p">]</span>
  <span class="n">ctrl_data</span> <span class="o">=</span> <span class="n">pca_final</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">idx_mask</span><span class="p">)]</span> 
  <span class="n">tx_data</span> <span class="o">=</span> <span class="n">pca_final</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_mask</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ctrl_data</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

  <span class="c1"># Define the first experiment as the training set and the 2nd as the test set</span>
  <span class="n">X_train</span> <span class="o">=</span> <span class="n">ctrl_data</span>
  <span class="n">y_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">disease_condition</span> <span class="o">==</span> <span class="s1">&#39;Active&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
  <span class="n">X_test</span> <span class="o">=</span> <span class="n">tx_data</span>
  
  <span class="c1"># Fit the model and get the coeficients</span>
  <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Classification Accuracy: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>
  <span class="n">weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span>
  <span class="n">weights_norm</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
  
  <span class="c1"># Define the disease axis as the weights from logistic regression (dot product with these weights = decision function)</span>
  <span class="n">dis_vec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">weights_norm</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">curr_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

  <span class="c1"># Calculate on-disease score based on scalar projection of each well&#39;s features onto the disease axis (dis_vec)</span>
  <span class="n">on_disease_score</span> <span class="o">=</span> <span class="n">curr_data</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dis_vec</span><span class="p">)</span> <span class="c1"># scalar projection (decision function)</span>

  <span class="c1"># Use Pythagorean theorem to calculate off-disease score</span>
  <span class="n">off_disease_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">on_disease_score</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>

  <span class="c1"># Setup disease scores </span>
  <span class="n">on_disease_score</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">off_disease_score</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">curr_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">off_disease_score</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1"># Normalize the scores to mean=0 for neg control and mean=1 for pos control</span>
  <span class="n">mean_pos</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pos_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
  <span class="n">mean_neg</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">neg_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
  <span class="n">curr_scores</span><span class="p">[</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="p">[</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean_neg</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mean_pos</span><span class="o">.</span><span class="n">on_disease_score</span> <span class="o">-</span> <span class="n">mean_neg</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">))</span>
  <span class="n">curr_scores</span><span class="p">[</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="p">[</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean_neg</span><span class="o">.</span><span class="n">off_disease_score</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mean_pos</span><span class="o">.</span><span class="n">off_disease_score</span> <span class="o">-</span> <span class="n">mean_neg</span><span class="o">.</span><span class="n">off_disease_score</span><span class="p">))</span>
  <span class="n">curr_scores</span><span class="o">.</span><span class="n">off_disease_score</span> <span class="o">-=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">on_disease_score</span> <span class="c1"># linear adjustment to get them on the same axis</span>

  <span class="c1"># Calculate the Z-factor based on the on-disease score</span>
  <span class="n">sd_pos</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pos_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
  <span class="n">sd_neg</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">neg_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
  <span class="n">mean_pos</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pos_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># need to recalculate means after transform</span>
  <span class="n">mean_neg</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">neg_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
  <span class="n">Zfactor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">sd_neg</span> <span class="o">+</span> <span class="n">sd_pos</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_pos</span> <span class="o">-</span> <span class="n">mean_neg</span><span class="p">)</span>

  <span class="c1"># Update the disease scores dataframe</span>
  <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_scores</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

<span class="c1"># Calculate the overall Z-factor across experiments (assuming poolability)</span>
<span class="n">sd_pos</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pos_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">sd_neg</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">neg_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">mean_pos</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pos_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mean_neg</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">neg_ctrl</span><span class="p">)]</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">Zfactor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">sd_neg</span> <span class="o">+</span> <span class="n">sd_pos</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_pos</span> <span class="o">-</span> <span class="n">mean_neg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HRCE-1 Classification Accuracy: 1.000
HRCE-2 Classification Accuracy: 1.000
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="evaluate-the-disease-model">
<h1>Evaluate the Disease Model<a class="headerlink" href="#evaluate-the-disease-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overlay-of-disease-axes-for-both-experiments">
<h2>Overlay of disease axes for both experiments<a class="headerlink" href="#overlay-of-disease-axes-for-both-experiments" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the controls and experiments to qualitatively examine agreement between experiments</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">));</span>
<span class="n">ctrl_mask</span> <span class="o">=</span> <span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Z-factors for each experiment:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Zfactor</span><span class="p">)):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zfactor</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">Zfactor</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ctrl_mask</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ctrl_mask</span><span class="p">][[</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;disease_condition&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;On-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Off-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Overall Z-factor: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zfactor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">]),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>

<span class="n">sns</span><span class="o">.</span><span class="n">move_legend</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Update legend</span>
<span class="n">lgnd</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
<span class="n">lgnd</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Disease Condition&#39;</span><span class="p">);</span>
<span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Exp1: Disease&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp 1: Healthy&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp2: Disease&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp2: Healthy&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lgnd</span><span class="o">.</span><span class="n">texts</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">):</span>
    <span class="n">t</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">lgnd</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;12&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">lgnd</span><span class="o">.</span><span class="n">get_title</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;14&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Z-factors for each experiment:
HRCE-1: 0.501
HRCE-2: 0.409
Overall: 0.458
</pre></div>
</div>
<img alt="_images/Recursion_2019a_HRCE_49_1.png" src="_images/Recursion_2019a_HRCE_49_1.png" />
</div>
</div>
</div>
<div class="section" id="pooled-disease-model">
<h2>Pooled Disease Model<a class="headerlink" href="#pooled-disease-model" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Overlap looks good above, plot the two experiments together (assumes batch effects sufficiently removed)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">));</span>
<span class="n">ctrl_mask</span> <span class="o">=</span> <span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ctrl_mask</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;On-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Off-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Overall Z-factor: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zfactor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">]),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>

<span class="n">sns</span><span class="o">.</span><span class="n">move_legend</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Update legend</span>
<span class="n">lgnd</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
<span class="n">lgnd</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Disease Condition&#39;</span><span class="p">);</span>
<span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Disease&#39;</span><span class="p">,</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lgnd</span><span class="o">.</span><span class="n">texts</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">):</span>
    <span class="n">t</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">lgnd</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;12&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">lgnd</span><span class="o">.</span><span class="n">get_title</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;14&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">);</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_51_0.png" src="_images/Recursion_2019a_HRCE_51_0.png" />
</div>
</div>
</div>
<div class="section" id="distributions-of-on-disease-scores-for-each-experiment">
<h2>Distributions of On-disease scores for each experiment<a class="headerlink" href="#distributions-of-on-disease-scores-for-each-experiment" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the on-disease and off-disease scores for each control, separately for the two experiments</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ctrl_mask</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;HRCE-1 On-Disease Score, Z-factor: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zfactor</span><span class="p">[</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;On-Disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Disease&#39;</span><span class="p">,</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">],</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">15</span><span class="p">});</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">experiment</span><span class="o">==</span><span class="s1">&#39;HRCE-2&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;HRCE-2 On-Disease Score, Z-factor: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zfactor</span><span class="p">[</span><span class="s1">&#39;HRCE-2&#39;</span><span class="p">]),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;On-Disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Disease&#39;</span><span class="p">,</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">],</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">15</span><span class="p">});</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_53_0.png" src="_images/Recursion_2019a_HRCE_53_0.png" />
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="comparison-of-consistency-across-experiments">
<h1>Comparison of consistency across experiments<a class="headerlink" href="#comparison-of-consistency-across-experiments" title="Permalink to this headline">¶</a></h1>
<div class="section" id="experiment-1-vs-experiment-2">
<h2>Experiment 1 vs. Experiment 2<a class="headerlink" href="#experiment-1-vs-experiment-2" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import Recursion&#39;s results data</span>
<span class="n">rx_disease_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Volumes/GoogleDrive/My Drive/Colab Notebooks/Recursion COVID/COVID_disease_scores.csv&#39;</span><span class="p">)</span>
<span class="n">rx_disease_scores</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;COVID19-launchedp1-HRCE-X-b-20x&#39;</span><span class="p">:</span> <span class="s1">&#39;HRCE-1&#39;</span><span class="p">,</span> <span class="s1">&#39;COVID19-launchedp2-HRCE-X-b-20x&#39;</span><span class="p">:</span> <span class="s1">&#39;HRCE-2&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rx_disease_scores</span> <span class="o">=</span> <span class="n">rx_disease_scores</span><span class="p">[(</span><span class="n">rx_disease_scores</span><span class="o">.</span><span class="n">experiment</span><span class="o">!=</span><span class="s1">&#39;COVID19-reference-VERO-48-a-20x&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rx_disease_scores</span><span class="o">.</span><span class="n">experiment</span><span class="o">!=</span><span class="s1">&#39;COVID19-reference-VERO-48-b-20x&#39;</span><span class="p">)]</span>
<span class="n">rx_hit_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Volumes/GoogleDrive/My Drive/Colab Notebooks/Recursion COVID/COVID_hit_scores.csv&#39;</span><span class="p">)</span>
<span class="n">rx_hit_scores</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;COVID19-launchedp1-HRCE-X-b-20x&#39;</span><span class="p">:</span> <span class="s1">&#39;HRCE-1&#39;</span><span class="p">,</span> <span class="s1">&#39;COVID19-launchedp2-HRCE-X-b-20x&#39;</span><span class="p">:</span> <span class="s1">&#39;HRCE-2&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rx_hit_scores</span> <span class="o">=</span> <span class="n">rx_hit_scores</span><span class="p">[(</span><span class="n">rx_hit_scores</span><span class="o">.</span><span class="n">experiment</span><span class="o">!=</span><span class="s1">&#39;COVID19-reference-VERO-48-a-20x&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rx_hit_scores</span><span class="o">.</span><span class="n">experiment</span><span class="o">!=</span><span class="s1">&#39;COVID19-reference-VERO-48-b-20x&#39;</span><span class="p">)]</span>

<span class="c1"># Plot the scores from the two experiments against each other to examine correlation</span>
<span class="c1"># Compare correlations in Recursion&#39;s data and my data</span>

<span class="n">summary</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment_conc&#39;</span><span class="p">])[[</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="s1">&#39;off_disease_score&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-2&#39;</span><span class="p">],</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_2&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">rx_summary</span> <span class="o">=</span> <span class="n">rx_disease_scores</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment_conc&#39;</span><span class="p">])[[</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="s1">&#39;off_disease_score&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">data_rx</span> <span class="o">=</span> <span class="n">rx_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rx_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-2&#39;</span><span class="p">],</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_2&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">data_rx</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>

<span class="n">pear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">on_disease_score_2</span><span class="p">)</span>
<span class="n">spear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">on_disease_score_2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;on_disease_score_2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="s1">&#39;Pearson r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">,</span> <span class="s1">&#39;Spearman r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;My On-disease Scores&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Experiment 1&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Experiment 2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>

<span class="n">pear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">data_rx</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">data_rx</span><span class="o">.</span><span class="n">on_disease_score_2</span><span class="p">)</span>
<span class="n">spear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">data_rx</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">data_rx</span><span class="o">.</span><span class="n">on_disease_score_2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;on_disease_score_2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_rx</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">,</span> <span class="s1">&#39;Pearson r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">2.9</span><span class="p">,</span> <span class="s1">&#39;Spearman r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Recursion On-disease Scores&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Experiment 1&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Experiment 2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>

<span class="n">pear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">off_disease_score</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">off_disease_score_2</span><span class="p">)</span>
<span class="n">spear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">off_disease_score</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">off_disease_score_2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;off_disease_score_2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="s1">&#39;Pearson r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;Spearman r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;My Off-disease Scores&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Experiment 1&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Experiment 2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>

<span class="n">pear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">data_rx</span><span class="o">.</span><span class="n">off_disease_score</span><span class="p">,</span> <span class="n">data_rx</span><span class="o">.</span><span class="n">off_disease_score_2</span><span class="p">)</span>
<span class="n">spear_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">data_rx</span><span class="o">.</span><span class="n">off_disease_score</span><span class="p">,</span> <span class="n">data_rx</span><span class="o">.</span><span class="n">off_disease_score_2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;off_disease_score_2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_rx</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="s1">&#39;Pearson r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;Spearman r: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spear_r</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Recursion Off-disease Scores&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Experiment 1&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Experiment 2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_56_0.png" src="_images/Recursion_2019a_HRCE_56_0.png" />
</div>
</div>
<div class="section" id="mean-difference-plots-between-the-2-experiments">
<h3>Mean-Difference plots between the 2 experiments<a class="headerlink" href="#mean-difference-plots-between-the-2-experiments" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use mean-difference plots to examine agreement between the replicated HRCE experiments</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-2&#39;</span><span class="p">],</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_2&#39;</span><span class="p">)</span>
<span class="n">data_rx</span> <span class="o">=</span> <span class="n">rx_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rx_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;HRCE-2&#39;</span><span class="p">],</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_2&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">mean_diff_plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">on_disease_score_2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;My Analysis - Exp 1 vs. Exp 2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Means of On-disease Scores&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Difference in On-disease Scores&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>

<span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">mean_diff_plot</span><span class="p">(</span><span class="n">data_rx</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">data_rx</span><span class="o">.</span><span class="n">on_disease_score_2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Recursion Analysis - Exp 1 vs. Exp 2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Means of On-disease Scores&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_58_0.png" src="_images/Recursion_2019a_HRCE_58_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="evaluation-of-drug-candidates">
<h1>Evaluation of Drug Candidates<a class="headerlink" href="#evaluation-of-drug-candidates" title="Permalink to this headline">¶</a></h1>
<div class="section" id="mean-score-of-each-treatment">
<h2>Mean score of each treatment<a class="headerlink" href="#mean-score-of-each-treatment" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">));</span>
<span class="n">ctrl_mask</span> <span class="o">=</span> <span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ctrl_mask</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;On-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Off-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Overall Z-factor: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zfactor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">]),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>

<span class="n">lgnd</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
<span class="n">handles</span> <span class="o">=</span> <span class="n">lgnd</span><span class="o">.</span><span class="n">legendHandles</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">group</span><span class="o">==</span><span class="s1">&#39;treated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;samp_group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">group</span><span class="o">==</span><span class="s1">&#39;treated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;samp_group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">off_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatments&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="n">handles2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">+</span><span class="n">handles2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Disease&#39;</span><span class="p">,</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">,</span> <span class="s1">&#39;Treatments&#39;</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">move_legend</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_61_0.png" src="_images/Recursion_2019a_HRCE_61_0.png" />
</div>
</div>
</div>
<div class="section" id="key-treatments-that-were-in-both-experiments">
<h2>Key treatments that were in both experiments<a class="headerlink" href="#key-treatments-that-were-in-both-experiments" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">treatments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Remdesivir (GS-5734)&#39;</span><span class="p">,</span> <span class="s1">&#39;GS-441524&#39;</span><span class="p">,</span> <span class="s1">&#39;Ritonavir&#39;</span><span class="p">,</span> <span class="s1">&#39;Lopinavir&#39;</span><span class="p">,</span> <span class="s1">&#39;Camostat&#39;</span><span class="p">,</span>  <span class="s1">&#39;Thymoquinone&#39;</span><span class="p">,</span> <span class="s1">&#39;Idelalisib&#39;</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;yellowgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;turquoise&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

<span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">,</span> <span class="s1">&#39;HRCE-2&#39;</span><span class="p">]):</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
  <span class="n">ctrl_mask</span> <span class="o">=</span> <span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
  <span class="n">exp1_ctrl</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">experiment</span> <span class="o">==</span> <span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">ctrl_mask</span><span class="p">)</span>
  <span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp1_ctrl</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">]);</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;On-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">));</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Off-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Z-factor: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">Zfactor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp</span><span class="p">]),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

  <span class="c1"># Plot each of the treatments and associated colors listed above</span>
  <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">tx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">treatments</span><span class="p">):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">exp</span><span class="p">,</span> <span class="n">tx</span><span class="p">)]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">off_disease_score</span><span class="p">,</span> <span class="s1">&#39;.-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">tx</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">off_disease_score</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  
  <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">});</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_63_0.png" src="_images/Recursion_2019a_HRCE_63_0.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-dose-response-curves-for-remdesivir">
<h2>Plot the dose-response curves for Remdesivir<a class="headerlink" href="#plot-the-dose-response-curves-for-remdesivir" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="c1"># Plot the data points</span>
<span class="n">data1</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;HRCE-1&#39;</span><span class="p">,</span> <span class="s1">&#39;Remdesivir (GS-5734)&#39;</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data1</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Remdesivir-1&#39;</span><span class="p">)</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;HRCE-2&#39;</span><span class="p">,</span> <span class="s1">&#39;Remdesivir (GS-5734)&#39;</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data2</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Remdesivir-2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;On-disease Score&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Concentration&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>

<span class="c1"># Fit to a generalized sigmoid function</span>
<span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="p">)))</span> <span class="o">+</span> <span class="n">c</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Fit and plot the data from each experiment</span>
<span class="n">coeffs1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">,</span> <span class="n">data1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data1</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">)</span>  
<span class="n">y_pred1</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="o">*</span><span class="n">coeffs1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">y_pred1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">);</span>

<span class="n">coeffs2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">,</span> <span class="n">data2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data2</span><span class="o">.</span><span class="n">on_disease_score</span><span class="p">)</span>  
<span class="n">y_pred2</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="o">*</span><span class="n">coeffs2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">y_pred2</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">);</span>
<span class="p">;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Remdesivir Dose-Response&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Concentration&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;On-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Experiment 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Experiment 2&#39;</span><span class="p">],</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">15</span><span class="p">});</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_65_0.png" src="_images/Recursion_2019a_HRCE_65_0.png" />
</div>
</div>
</div>
<div class="section" id="hit-scores">
<h2>Hit Scores<a class="headerlink" href="#hit-scores" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A treatment will be considered a hit based on a 2D Gaussian kernel around the negative control group (Inactive)</p>
<ul>
<li><p>The kernel will have mean = (0,0) and SD = 6*SD in each of the disease directions</p></li>
<li><p>Hit threshold was set as 0.7 (qualitatively selected based on visual inspection of the plot below)</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neg_ctrl_data</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neg_ctrl</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="s1">&#39;off_disease_score&#39;</span><span class="p">]]</span>
<span class="n">treated_data</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">group</span><span class="o">==</span><span class="s1">&#39;treated&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;samp_group&#39;</span><span class="p">)[[</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="s1">&#39;off_disease_score&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;samp_group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="n">A</span><span class="o">=</span><span class="mi">1</span>
<span class="n">X0</span><span class="o">=</span><span class="n">neg_ctrl_data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">Y0</span><span class="o">=</span><span class="n">neg_ctrl_data</span><span class="o">.</span><span class="n">off_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sig_X</span> <span class="o">=</span> <span class="n">neg_ctrl_data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">6</span>
<span class="n">sig_Y</span> <span class="o">=</span> <span class="n">neg_ctrl_data</span><span class="o">.</span><span class="n">off_disease_score</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">6</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">treated_data</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">treated_data</span><span class="o">.</span><span class="n">off_disease_score</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="n">hitscore</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">X0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig_X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">Y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig_Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">hitscore</span> <span class="o">=</span> <span class="n">hitscore</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;hit_score&#39;</span><span class="p">)</span>
<span class="n">hit_scores</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hitscore</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;hit_score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">hits</span> <span class="o">=</span> <span class="n">hit_scores</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;treatment&#39;</span><span class="p">)[</span><span class="s1">&#39;hit_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hits</span><span class="p">[</span><span class="n">hits</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              treatment  hit_score
0             GS-441524   0.997216
1  Remdesivir (GS-5734)   0.991494
2       trihexyphenidyl   0.949988
3           Aloxistatin   0.899380
4          cloperastine   0.733459
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">.451</span><span class="p">,</span> <span class="mf">0.451</span><span class="p">,</span> <span class="mf">0.91</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig_Y</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig_X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">threshold</span><span class="p">)))</span>
<span class="n">y2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig_Y</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig_X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">threshold</span><span class="p">)))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span> <span class="n">y1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">));</span>
<span class="n">ctrl_mask</span> <span class="o">=</span> <span class="n">main_ctrls</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;on_disease_score&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;off_disease_score&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ctrl_mask</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;disease_condition&#39;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Inactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;On-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Off-disease Score&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Overall Z-factor: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zfactor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">]),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>

<span class="n">lgnd</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
<span class="n">handles</span> <span class="o">=</span> <span class="n">lgnd</span><span class="o">.</span><span class="n">legendHandles</span>

<span class="n">x_treat</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">group</span><span class="o">==</span><span class="s1">&#39;treated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;samp_group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">y_treat</span> <span class="o">=</span> <span class="n">disease_scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">disease_scores</span><span class="o">.</span><span class="n">group</span><span class="o">==</span><span class="s1">&#39;treated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;samp_group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">off_disease_score</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_treat</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_treat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatments&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">handles2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Hit Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Recursion_2019a_HRCE_68_0.png" src="_images/Recursion_2019a_HRCE_68_0.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By The Jupyter Book community<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>